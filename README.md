# Kikyo Discord BOT

å¤šè§’è‰² Discord Bot ç³»çµ±ï¼Œæ”¯æ´ç¨ç«‹çš„è™›æ“¬äººç‰©è§’è‰²ï¼Œæ¯å€‹è§’è‰²éƒ½æœ‰å°ˆå±¬çš„ AI è¨˜æ†¶ç³»çµ±ã€‚å…·å‚™ç¾¤çµ„å°è©±è¿½è¹¤åŠŸèƒ½ï¼Œè®“ BOT èƒ½å¤ æ„ŸçŸ¥å¤šä½¿ç”¨è€…å°è©±ç’°å¢ƒä¸¦è‡ªç„¶åœ°èˆ‡æ‰€æœ‰åƒèˆ‡è€…äº’å‹•ã€‚

## ğŸš€ å¿«é€Ÿé–‹å§‹

å®Œæ•´å®‰è£æ–‡ä»¶ï¼šhttps://hackmd.io/@kikyoicecream/H1lydGdree

## ğŸ¯ ç³»çµ±ç‰¹è‰²

- ğŸ­ **å¤šè§’è‰²æ”¯æ´**ï¼šåŒæ™‚ Host å¤šå€‹ BOTï¼Œæ¨¡çµ„åŒ–æ–°å¢è§’è‰²
- ğŸ§  **æ™ºæ…§è¨˜æ†¶ç³»çµ±**ï¼šåŸºæ–¼ AI çš„è¨˜æ†¶æå–ã€çµ±æ•´èˆ‡ç®¡ç†
- ğŸ“ **Prompt æ¨¡æ¿ç³»çµ±**ï¼šæ¨¡çµ„åŒ–çš„ AI æç¤ºè©ç®¡ç†ï¼Œæ”¯æ´å‹•æ…‹é…ç½®
- ğŸ‘¥ **ç¾¤çµ„å°è©±è¿½è¹¤**ï¼šè¿½è¹¤æ´»èºä½¿ç”¨è€…ï¼Œæ”¯æ´å¤šä½¿ç”¨è€…ç¾¤çµ„å°è©±
- ğŸ’¬ **ç§è¨ŠåŠŸèƒ½**ï¼šæ”¯æ´èˆ‡æˆæ¬Šä½¿ç”¨è€…çš„ç§è¨Šå°è©±ï¼Œå…·å‚™æ¬Šé™ç®¡ç†
- âœ¨ **è¡¨æƒ…ç¬¦è™Ÿå›æ‡‰**ï¼šä¾ç…§ä½¿ç”¨è€…å°è©±å…§å®¹ï¼Œè§¸ç™¼è¡¨æƒ…ç¬¦è™Ÿå›æ‡‰
- ğŸ”§ **çµ±ä¸€é›²ç«¯é…ç½®**ï¼šæ‰€æœ‰è¨­å®šã€åƒæ•¸ã€æç¤ºè©éƒ½å„²å­˜åœ¨ Firestore
- ğŸš€ **è‡ªå‹•é‡å•Ÿ**ï¼šBot ç•°å¸¸æ™‚è‡ªå‹•é‡å•ŸåŠŸèƒ½
- ğŸ”’ **å®‰å…¨éæ¿¾**ï¼šå…¨åŸŸ Gemini AI å®‰å…¨éæ¿¾å™¨ä¿è­·
- ğŸ¯ **æ–œç·šæŒ‡ä»¤**ï¼škeywordã€memoryã€restartã€intro å››ç¨®æ–œç·šæŒ‡ä»¤
- âš¡ **çµ±ä¸€æ¶æ§‹**ï¼šFirebase çµ±ä¸€ç®¡ç†å™¨ï¼Œç°¡åŒ–ä»£ç¢¼ç¶­è­·

## ğŸ“ å°ˆæ¡ˆçµæ§‹

```
Kikyo Discord BOT/
â”œâ”€â”€ main.py                         # ä¸»ç¨‹å¼ - å¤š Bot å•Ÿå‹•å™¨
â”œâ”€â”€ character_bot.py                # è§’è‰² Bot æ ¸å¿ƒé‚è¼¯
â”œâ”€â”€ character_registry_custom.py    # è§’è‰²è¨»å†Šèˆ‡è¨­å®šç®¡ç†
â”œâ”€â”€ emoji_responses.py              # è¡¨æƒ…ç¬¦è™Ÿå›æ‡‰ç³»çµ±
â”œâ”€â”€ memory.py                       # AI è¨˜æ†¶ç®¡ç†èˆ‡å›æ‡‰ç”Ÿæˆ
â”œâ”€â”€ group_conversation_tracker.py   # ç¾¤çµ„å°è©±è¿½è¹¤
â”œâ”€â”€ firebase_utils.py               # Firebase çµ±ä¸€ç®¡ç†å™¨ ğŸ†•
â”œâ”€â”€ requirements.txt                # Python ä¾è³´å¥—ä»¶
â”œâ”€â”€ README.md                       # å°ˆæ¡ˆèªªæ˜æ–‡ä»¶
â””â”€â”€ .env                            # ç’°å¢ƒè®Šæ•¸é…ç½®
```

## ğŸ—„ï¸ Firestore è³‡æ–™åº«çµæ§‹

```
your-project/
â”œâ”€â”€ prompt/                        # ğŸ†• AI æç¤ºè©æ¨¡æ¿ç³»çµ±
â”‚   â”œâ”€â”€ user_memories/             # è¨˜æ†¶æå–æç¤ºè©
â”‚   â”‚   â”œâ”€â”€ content: "æç¤ºè©å…§å®¹"
â”‚   â”‚   â””â”€â”€ model: "gemini-2.0-flash"
â”‚   â”œâ”€â”€ memories_summary/          # è¨˜æ†¶çµ±æ•´æç¤ºè©
â”‚   â”‚   â”œâ”€â”€ content: "æç¤ºè©å…§å®¹"
â”‚   â”‚   â”œâ”€â”€ model: "gemini-2.0-flash"
â”‚   â”‚   â””â”€â”€ memory_limit: 15       # ğŸ†• è¨˜æ†¶çµ±æ•´é–€æª»
â”‚   â””â”€â”€ system/                    # ç³»çµ±è§’è‰²æç¤ºè©
â”‚       â”œâ”€â”€ content: "æç¤ºè©å…§å®¹"
â”‚       â””â”€â”€ model: "gemini-2.5-pro"
â”œâ”€â”€ {character_id}/                # è§’è‰²è¨­å®š
â”‚   â”œâ”€â”€ profile/                   # è§’è‰²è¨­å®šæª”
â”‚   â”œâ”€â”€ users/                     # ä½¿ç”¨è€…è¨˜æ†¶ï¼ˆå–®ä¸€æ–‡ä»¶ï¼‰
â”‚   â”‚   â””â”€â”€ {user_id}: []          # ä½¿ç”¨è€… ID å°æ‡‰è¨˜æ†¶é™£åˆ—
â”‚   â”œâ”€â”€ emoji_system/              # è¡¨æƒ…ç¬¦è™Ÿç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ general_emojis: []
â”‚   â”‚   â”œâ”€â”€ trigger_emojis: {}
â”‚   â”‚   â”œâ”€â”€ trigger_keywords: {}
â”‚   â”‚   â”œâ”€â”€ general_probability: 0.3
â”‚   â”‚   â””â”€â”€ server_probability: 0.2
â”‚   â””â”€â”€ system/                    # ç³»çµ±é…ç½®
â”‚       â”œâ”€â”€ name: "è§’è‰²åç¨±"
â”‚       â”œâ”€â”€ token_env: "{CHARACTER_ID}_TOKEN"
â”‚       â”œâ”€â”€ proactive_keywords: []
â”‚       â”œâ”€â”€ enabled: true
â”‚       â”œâ”€â”€ allowed_guilds: []
â”‚       â”œâ”€â”€ allowed_channels: []
â”‚       â”œâ”€â”€ enable_dm: false       # ğŸ†• ç§è¨ŠåŠŸèƒ½é–‹é—œ
â”‚       â”œâ”€â”€ allowed_dm_users: []   # ğŸ†• å…è¨±ç§è¨Šçš„ä½¿ç”¨è€… ID åˆ—è¡¨
â”‚       â”œâ”€â”€ intro: "è§’è‰²ç°¡ä»‹æ–‡å­—"
â”‚       â””â”€â”€ gemini_config: {       # ğŸ†• çµ±ä¸€ Gemini é…ç½®
â”‚           â”œâ”€â”€ model: "gemini-2.5-pro"
â”‚           â”œâ”€â”€ temperature: 1.0
â”‚           â”œâ”€â”€ top_k: 40
â”‚           â”œâ”€â”€ top_p: 0.9
â”‚           â”œâ”€â”€ max_output_tokens: 2048
â”‚           â””â”€â”€ enabled: true
â”‚       }
```

## ğŸ§  AI è¨˜æ†¶èˆ‡æç¤ºè©ç³»çµ±

### ğŸ“ Prompt æ¨¡æ¿ç³»çµ±

æœ¬ç³»çµ±æ¡ç”¨æ¨¡çµ„åŒ–çš„ AI æç¤ºè©ç®¡ç†ï¼Œæ‰€æœ‰æç¤ºè©éƒ½å„²å­˜åœ¨ Firestore çš„ `prompt` é›†åˆä¸­ï¼š

#### **1. `user_memories` - è¨˜æ†¶æå–æç¤ºè©**
- **åŠŸèƒ½**ï¼šå¾ä½¿ç”¨è€…å°è©±ä¸­æå–é‡è¦è³‡è¨Šä¸¦ç”Ÿæˆçµæ§‹åŒ–è¨˜æ†¶
- **ä½¿ç”¨æ™‚æ©Ÿ**ï¼šæ¯ç•¶ä½¿ç”¨è€…èˆ‡è§’è‰²å°è©±å¾Œè‡ªå‹•è§¸ç™¼
- **å¯ç”¨è®Šæ•¸**ï¼š`{character_name}`, `{user_name}`
- **è¼¸å‡º**ï¼šç°¡æ½”çš„è¨˜æ†¶æ¢ç›®ï¼ˆæ¯æ¢ < 40 å­—ï¼‰

#### **2. `memories_summary` - è¨˜æ†¶çµ±æ•´æç¤ºè©**
- **åŠŸèƒ½**ï¼šç•¶è¨˜æ†¶æ¢ç›®éå¤šæ™‚ï¼Œå°‡å¤šæ¢è¨˜æ†¶æ•´åˆæˆç²¾ç°¡æ‘˜è¦
- **ä½¿ç”¨æ™‚æ©Ÿ**ï¼šç•¶ä½¿ç”¨è€…è¨˜æ†¶æ•¸é‡è¶…é `memory_limit` é–€æª»æ™‚è‡ªå‹•è§¸ç™¼
- **å¯ç”¨è®Šæ•¸**ï¼š`{user_name}`
- **é…ç½®**ï¼š`memory_limit` - è¨˜æ†¶çµ±æ•´é–€æª»ï¼ˆé è¨­ 15 æ¢ï¼‰
- **è¼¸å‡º**ï¼šçµ±æ•´å¾Œçš„è¨˜æ†¶æ‘˜è¦ï¼ˆ< 300 å­—ï¼‰

#### **3. `system` - ç³»çµ±è§’è‰²æç¤ºè©**
- **åŠŸèƒ½**ï¼šå®šç¾©è§’è‰²çš„è¡Œç‚ºæ¨¡å¼ã€èªªè©±é¢¨æ ¼å’Œå›æ‡‰é‚è¼¯
- **ä½¿ç”¨æ™‚æ©Ÿ**ï¼šæ¯æ¬¡ç”Ÿæˆè§’è‰²å›æ‡‰æ™‚éƒ½æœƒä½¿ç”¨
- **å¯ç”¨è®Šæ•¸**ï¼š`{character_name}`
- **å‹•æ…‹çµ„åˆ**ï¼šè§’è‰²è¨­å®š + ç¾¤çµ„æƒ…æ³ + ä½¿ç”¨è€…è¨˜æ†¶ + ç•¶å‰å°è©±

### ğŸ”„ è¨˜æ†¶ç³»çµ±å·¥ä½œæµç¨‹

```mermaid
graph TD
    A[ä½¿ç”¨è€…å°è©±] --> B[user_memories æå–è¨˜æ†¶]
    B --> C[ç”Ÿæˆè¨˜æ†¶æ¢ç›®]
    C --> D{è¨˜æ†¶æ•¸é‡ > memory_limit?}
    D -->|æ˜¯| E[memories_summary çµ±æ•´è¨˜æ†¶]
    D -->|å¦| F[ä¿å­˜è¨˜æ†¶]
    E --> G[çµ±æ•´ç‚ºæ‘˜è¦]
    G --> F
    F --> H[system ç”Ÿæˆå›æ‡‰]
    H --> I[è§’è‰²å›æ‡‰ä½¿ç”¨è€…]
```

### ğŸ›ï¸ å‹•æ…‹é…ç½®ç‰¹æ€§

- **å³æ™‚èª¿æ•´**ï¼šä¿®æ”¹ Firestore ä¸­çš„ `memory_limit` ç„¡éœ€é‡å•Ÿ BOT
- **è§’è‰²å°ˆå±¬**ï¼šæ¯å€‹è§’è‰²å¯ä½¿ç”¨ä¸åŒçš„ Gemini æ¨¡å‹å’Œåƒæ•¸
- **å¿«å–æ©Ÿåˆ¶**ï¼šæç¤ºè©å’Œé…ç½®å…·å‚™å¿«å–åŠŸèƒ½ï¼Œæå‡æ•ˆèƒ½
- **éŒ¯èª¤è™•ç†**ï¼šå®Œæ•´çš„è®Šæ•¸æª¢æŸ¥å’ŒéŒ¯èª¤æç¤º

## ğŸ‘¥ ç¾¤çµ„å°è©±è¿½è¹¤åŠŸèƒ½

### åŠŸèƒ½æ¦‚è¿°
- **æ´»èºä½¿ç”¨è€…è¿½è¹¤**ï¼šè¨˜éŒ„å“ªäº›ä½¿ç”¨è€…æ­£åœ¨èˆ‡ BOT å°è©±
- **ç¾¤çµ„å°è©±ä¸Šä¸‹æ–‡**ï¼šäº†è§£æ•´å€‹å°è©±çš„è„ˆçµ¡
- **ä¸»å‹•æåŠå…¶ä»–ä½¿ç”¨è€…**ï¼šBOT å¯ä»¥è‡ªç„¶åœ°æåŠå…¶ä»–æ´»èºä½¿ç”¨è€…
- **AI å°è©±æ‘˜è¦**ï¼šç”Ÿæˆç¾¤çµ„å°è©±çš„æ‘˜è¦
- **BOT å›æ‡‰è¿½è¹¤**ï¼šè¨˜éŒ„ BOT è‡ªå·±çš„ç™¼è¨€ï¼Œç¢ºä¿å°è©±é€£çºŒæ€§

## ğŸ­ æ–œç·šæŒ‡ä»¤ç³»çµ±

### å¯ç”¨æŒ‡ä»¤

æ¯å€‹è§’è‰²éƒ½æœ‰ä»¥ä¸‹æ–œç·šæŒ‡ä»¤ï¼š

#### `/{character_prefix}_restart`
- **åŠŸèƒ½**ï¼šé‡æ–°å•Ÿå‹• Bot
- **ç¯„ä¾‹**ï¼š`/shen_ze_restart`ã€`/gu_beichen_restart`

#### `/{character_prefix}_keywords`
- **åŠŸèƒ½**ï¼šé¡¯ç¤ºè§’è‰²çš„ä¸»å‹•é—œéµå­—
- **ç¯„ä¾‹**ï¼š`/shen_ze_keywords`ã€`/gu_beichen_keywords`
- **é¡¯ç¤ºå…§å®¹**ï¼šè§’è‰²åç¨±å’Œå°æ‡‰çš„é—œéµå­—åˆ—è¡¨

#### `/{character_prefix}_memories`
- **åŠŸèƒ½**ï¼šé¡¯ç¤ºè§’è‰²èˆ‡ä½¿ç”¨è€…çš„è¨˜æ†¶å…§å®¹
- **ç¯„ä¾‹**ï¼š`/shen_ze_memories`ã€`/gu_beichen_memories`

#### `/{character_prefix}_intro`
- **åŠŸèƒ½**ï¼šé¡¯ç¤ºè§’è‰²çš„ç°¡ä»‹è³‡è¨Š
- **ç¯„ä¾‹**ï¼š`/shen_ze_intro`ã€`/gu_beichen_intro`
- **é¡¯ç¤ºå…§å®¹**ï¼šå¾ Firestore `/{character_id}/system/intro` è®€å–çš„è§’è‰²ç°¡ä»‹

## ğŸ’¬ ç§è¨ŠåŠŸèƒ½

### åŠŸèƒ½æ¦‚è¿°
- **ç§è¨Šå°è©±**ï¼šæ”¯æ´èˆ‡æˆæ¬Šä½¿ç”¨è€…çš„ç§è¨Šå°è©±
- **æ¬Šé™ç®¡ç†**ï¼šå¯è¨­å®šå…è¨±ç§è¨Šçš„ä½¿ç”¨è€…æ¸…å–®
- **åŠŸèƒ½é–‹é—œ**ï¼šæ¯å€‹è§’è‰²å¯ç¨ç«‹å•Ÿç”¨/åœç”¨ç§è¨ŠåŠŸèƒ½
- **å®‰å…¨æ§åˆ¶**ï¼šæœªæˆæ¬Šä½¿ç”¨è€…å˜—è©¦ç§è¨Šæ™‚æœƒæ”¶åˆ°æç¤ºè¨Šæ¯

### å·¥ä½œæµç¨‹
```mermaid
graph TD
    A[ä½¿ç”¨è€…ç™¼é€ç§è¨Š] --> B{ç§è¨ŠåŠŸèƒ½å•Ÿç”¨?}
    B -->|å¦| C[å¿½ç•¥è¨Šæ¯]
    B -->|æ˜¯| D{ä½¿ç”¨è€…åœ¨æˆæ¬Šæ¸…å–®?}
    D -->|å¦| E[ç™¼é€æ¬Šé™ä¸è¶³æç¤º]
    D -->|æ˜¯| F[è™•ç†ç§è¨Šå°è©±]
    F --> G[ç”Ÿæˆè§’è‰²å›æ‡‰]
    G --> H[ç™¼é€ç§è¨Šå›æ‡‰]
```

### å®‰å…¨ç‰¹æ€§
- **é è¨­åœç”¨**ï¼šæ–°è§’è‰²é è¨­ä¸å•Ÿç”¨ç§è¨ŠåŠŸèƒ½
- **ç™½åå–®æ©Ÿåˆ¶**ï¼šåªæœ‰æ˜ç¢ºæˆæ¬Šçš„ä½¿ç”¨è€…æ‰èƒ½ç§è¨Š
- **éŒ¯èª¤è™•ç†**ï¼šç„¡æ³•ç™¼é€æç¤ºè¨Šæ¯æ™‚æœƒéœé»˜å¿½ç•¥
- **æ¬Šé™æª¢æŸ¥**ï¼šæ¯æ¬¡ç§è¨Šéƒ½æœƒé©—è­‰ä½¿ç”¨è€…æ¬Šé™

## âš™ï¸ é…ç½®ç®¡ç†

### ç’°å¢ƒè®Šæ•¸è¨­å®š
åœ¨ `.env` æª”æ¡ˆä¸­è¨­å®šä»¥ä¸‹ç’°å¢ƒè®Šæ•¸ï¼š

```bash
# Discord Bot Token è¨­å®š
SHEN_ZE_TOKEN=ä½ çš„Discord_Bot_Token
GU_BEICHEN_TOKEN=ä½ çš„Discord_Bot_Token
FAN_CHENGXI_TOKEN=ä½ çš„Discord_Bot_Token
CHEN_ZHIWEN_TOKEN=ä½ çš„Discord_Bot_Token

# Google Gemini API è¨­å®š
GOOGLE_API_KEY=ä½ çš„Google_API_Key

# Firebase è¨­å®šï¼ˆé‡è¦ï¼šå¿…é ˆæ˜¯å®Œæ•´çš„ä¸€è¡Œ JSONï¼‰
FIREBASE_CREDENTIALS_JSON={"type":"service_account","project_id":"ä½ çš„å°ˆæ¡ˆID",...å®Œæ•´çš„Firebaseæ†‘è­‰JSON...}
```

### ğŸš¨ é‡è¦è¨­å®šæé†’

1. **Firebase æ†‘è­‰**ï¼š`FIREBASE_CREDENTIALS_JSON` å¿…é ˆæ˜¯å®Œæ•´çš„ä¸€è¡Œ JSON å­—ä¸²ï¼Œä¸èƒ½æœ‰æ›è¡Œ
2. **Discord Token**ï¼šç’°å¢ƒè®Šæ•¸åç¨±å¿…é ˆèˆ‡ Firestore ä¸­çš„ `token_env` æ¬„ä½å°æ‡‰
3. **æ’é™¤é›†åˆ**ï¼šç³»çµ±æœƒè‡ªå‹•æ’é™¤ `template`ã€`prompt` ä¹‹éè§’è‰²é›†åˆ

## ğŸ”§ é–‹ç™¼èªªæ˜

### ç¨‹å¼æ¶æ§‹ç‰¹è‰²
- **ğŸ†• çµ±ä¸€ç®¡ç†å™¨**ï¼š`firebase_utils.py` æä¾›çµ±ä¸€çš„ Firestore é€£æ¥å’Œå¿«å–ç®¡ç†
- **æ¨¡çµ„åŒ–è¨­è¨ˆ**ï¼šæ ¸å¿ƒåŠŸèƒ½åˆ†é›¢ï¼Œæ˜“æ–¼ç¶­è­·å’Œæ“´å±•
- **é›²ç«¯é…ç½®**ï¼šæ‰€æœ‰è¨­å®šéƒ½å„²å­˜åœ¨ Firestoreï¼Œæ”¯æ´å³æ™‚èª¿æ•´
- **å®Œæ•´éŒ¯èª¤è™•ç†**ï¼šè©³ç´°çš„ç•°å¸¸è™•ç†å’Œèª¿è©¦è³‡è¨Š
- **æ•ˆèƒ½æœ€ä½³åŒ–**ï¼šå¿«å–æ©Ÿåˆ¶æ¸›å°‘ Firestore è®€å–æ¬¡æ•¸
- **æ—¥èªŒè¨˜éŒ„**ï¼šæ¸…æ™°çš„é‹è¡Œç‹€æ…‹å’ŒéŒ¯èª¤è¨Šæ¯

## ğŸ“‹ ç’°å¢ƒéœ€æ±‚

- **Python 3.9+**
- **Discord.py >= 2.3.0**
- **Firebase Admin SDK >= 6.0.0**
- **Google Generative AI == 0.8.3**
- **python-dotenv >= 1.0.0**
- **å…¶ä»–ç›¸ä¾å¥—ä»¶**è«‹åƒè€ƒ `requirements.txt`

## æˆæ¬Š
æ­¤å°ˆæ¡ˆåƒ…ä¾›å€‹äººä½¿ç”¨å’Œå­¸ç¿’ç›®çš„ã€‚